<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebRTC Video Call</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        background-color: #f4f4f4;
        color: #333;
      }
      video {
        width: 45%;
        border: 2px solid #007bff;
        border-radius: 8px;
        margin: 10px;
        background-color: #000;
      }
      button {
        padding: 10px;
        margin: 5px;
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <h2>WebRTC Video Call (ID: <span id="myId">?</span>)</h2>
    <div>
      <input id="peerIdInput" placeholder="ID собеседника" />
      <button onclick="startCall()">Позвонить</button>
      <button onclick="hangUp()">Завершить</button>
      <button onclick="getLink()">Получить ссылку</button>
    </div>

    <p id="statusMessage">Ожидание...</p>

    <div>
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <script>
      const socket = io();
      let myId = null;
      let currentPeerId = null;
      let pc = null;
      let localStream = null;
      let remoteDescriptionSet = false;
      let pendingCandidates = [];

      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const peerIdInput = document.getElementById("peerIdInput");
      const myIdEl = document.getElementById("myId");
      const statusEl = document.getElementById("statusMessage");

      function setStatus(msg, err = false) {
        statusEl.textContent = msg;
        statusEl.style.color = err ? "red" : "#333";
      }

      async function getLocalStream() {
        if (localStream) return localStream;
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localVideo.srcObject = localStream;
          return localStream;
        } catch (e) {
          setStatus("Ошибка доступа к камере/микрофону", true);
          console.error(e);
          return null;
        }
      }

      function createPeerConnection() {
        pc = new RTCPeerConnection({
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            {
              urls: "turn:217.154.5.134:3478",
              username: "webrtc",
              credential: "SuperSecurePass123",
            },
          ],
        });

        pc.onicecandidate = (event) => {
          if (event.candidate && currentPeerId) {
            socket.emit("message", { to: currentPeerId, type: "ice-candidate", candidate: event.candidate });
          }
        };

        pc.ontrack = (e) => {
          remoteVideo.srcObject = e.streams[0];
          setStatus("Удалённый поток получен!");
        };

        pc.onconnectionstatechange = () => {
          if (["failed", "disconnected", "closed"].includes(pc.connectionState)) hangUp();
        };
      }

      async function startCall() {
        const target = peerIdInput.value.trim();
        if (!target) return setStatus("Введите ID собеседника", true);
        if (target === myId) return setStatus("Нельзя звонить самому себе", true);

        const stream = await getLocalStream();
        if (!stream) return;

        createPeerConnection();
        stream.getTracks().forEach((t) => pc.addTrack(t, stream));
        remoteDescriptionSet = false;
        pendingCandidates = [];

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        currentPeerId = target;
        socket.emit("message", { to: target, type: "offer", sdp: offer });
        setStatus("Отправлен offer, ожидаем ответ...");
      }

      async function handleOffer(msg) {
        currentPeerId = msg.from;

        const stream = await getLocalStream();
        if (!stream) return;

        createPeerConnection();
        stream.getTracks().forEach((t) => pc.addTrack(t, stream));
        remoteDescriptionSet = false;
        pendingCandidates = [];

        await setRemoteDescription(msg.sdp);

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit("message", { to: msg.from, type: "answer", sdp: answer });
        setStatus("Ответ отправлен");
      }

      async function handleIceCandidate(candidate) {
        if (pc && remoteDescriptionSet) {
          try {
            await pc.addIceCandidate(new RTCIceCandidate(candidate));
          } catch (e) {
            console.warn("Ошибка добавления ICE-кандидата:", e);
          }
        } else {
          pendingCandidates.push(candidate);
        }
      }

      async function setRemoteDescription(sdp) {
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
        remoteDescriptionSet = true;

        // добавляем все отложенные кандидаты
        for (const c of pendingCandidates) {
          try { await pc.addIceCandidate(new RTCIceCandidate(c)); }
          catch(e){ console.warn("Ошибка добавления ICE:", e); }
        }
        pendingCandidates = [];
      }

      socket.on("message", async (msg) => {
        if (msg.type === "offer") return handleOffer(msg);
        if (msg.type === "answer") return setRemoteDescription(msg.sdp);
        if (msg.type === "ice-candidate") return handleIceCandidate(msg.candidate);
      });

      socket.on("yourId", (id) => {
        myId = id;
        myIdEl.textContent = id;
        setStatus(`Ваш ID: ${id}`);
        const join = new URLSearchParams(location.search).get("join");
        if (join && join !== id) peerIdInput.value = join;
      });

      function hangUp() {
        if (pc) pc.close();
        pc = null;
        currentPeerId = null;
        remoteDescriptionSet = false;
        pendingCandidates = [];
        setStatus("Звонок завершён");
      }

      function getLink() {
        if (!myId) return alert("ID ещё не получен!");
        const url = new URL(location);
        url.searchParams.set("join", myId);
        navigator.clipboard.writeText(url.toString());
        alert("Ссылка скопирована:\n" + url);
      }
    </script>
  </body>
</html>
