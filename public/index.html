<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebRTC Video Call</title>
    <style>
      video {
        width: 48%;
        height: auto;
        border: 1px solid #ccc;
        background-color: #333; /* –î–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø—É—Å—Ç—ã—Ö –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–≤ */
      }
      #localVideo {
        transform: scaleX(-1);
      } /* –∑–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã */
    </style>
  </head>
  <body>
    <h2>WebRTC Video Call (ID: <span id="myId">?</span>)</h2>
    <p>
      –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –¥–≤—É—Ö –≤–∫–ª–∞–¥–∫–∞—Ö. –í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ
      "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫".
    </p>
    <input id="peerIdInput" placeholder="ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞" />
    <button onclick="startCall()">–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
    <button onclick="hangUp()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    <button onclick="getMyId()">Get ID</button>
    <button onclick="getLink()">Get link</button>

    <div style="margin-top: 20px">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <script>
      const isLocalDev =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1";

      // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º wss, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–æ https
      const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws`);

      let myId = null;
      let currentPeerId = null; // –ò–∑–º–µ–Ω–µ–Ω–æ —Å peerId –Ω–∞ currentPeerId –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
      let pc = null;
      let localStream = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞

      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const myIdEl = document.getElementById("myId");
      const peerIdInput = document.getElementById("peerIdInput"); // –ü–æ–ª—É—á–∞–µ–º input

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–≤–æ–Ω–∫–∞
      function resetCallState() {
        if (pc) {
          pc.close();
          pc = null;
        }
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
        }
        localVideo.srcObject = null;
        remoteVideo.srcObject = null;
        currentPeerId = null;
        peerIdInput.value = "";
      }

      async function getLocalStream() {
        if (localStream) return localStream; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ—Ç–æ–∫, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          localVideo.srcObject = stream;
          localStream = stream; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ç–æ–∫
          return stream;
        } catch (e) {
          console.error("–ö–∞–º–µ—Ä–∞/–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã", e);
          alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É!");
          return null;
        }
      }

      function createPeerConnection() {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        if (pc) {
          pc.close();
        }

        pc = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        pc.onicecandidate = (event) => {
          if (event.candidate && currentPeerId) {
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ currentPeerId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            ws.send(
              JSON.stringify({
                to: currentPeerId,
                type: "ice-candidate",
                candidate: event.candidate,
              })
            );
          }
        };

        pc.ontrack = (event) => {
          console.log("–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫:", event.track, event.streams);
          if (remoteVideo.srcObject !== event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
          }
        };

        pc.onconnectionstatechange = () => {
          console.log("–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:", pc.connectionState);
          if (pc.connectionState === "disconnected" || pc.connectionState === "failed" || pc.connectionState === "closed") {
            console.log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å. –†–∞–∑–≤–µ—à–∏–≤–∞–µ–º —Ç—Ä—É–±–∫—É.");
            hangUp();
          }
        };
      }

      async function startCall() {
        const targetPeerId = peerIdInput.value.trim(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π input
        if (!targetPeerId) return alert("–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞!");
        if (!myId) return alert("–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞—à–µ–≥–æ ID –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞...");
        if (targetPeerId === myId) return alert("–ù–µ–ª—å–∑—è –∑–≤–æ–Ω–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ!");

        // –ï—Å–ª–∏ –∑–≤–æ–Ω–æ–∫ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤–æ–≥–æ
        if (pc) {
          hangUp();
        }
        
        currentPeerId = targetPeerId; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentPeerId –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º PC

        const stream = await getLocalStream();
        if (!stream) return;

        createPeerConnection();
        stream.getTracks().forEach((track) => pc.addTrack(track, stream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer –∫:", currentPeerId, offer);
        ws.send(
          JSON.stringify({
            to: currentPeerId,
            type: "offer",
            sdp: offer, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º sdp –æ–±—ä–µ–∫—Ç
          })
        );
      }

      async function handleOffer(msg) {
        console.log("–ü–æ–ª—É—á–µ–Ω offer:", msg);
        // –ï—Å–ª–∏ –∑–≤–æ–Ω–æ–∫ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤–æ–≥–æ
        if (pc) {
          hangUp();
        }

        currentPeerId = msg.from; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentPeerId –æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è offer
        peerIdInput.value = currentPeerId; // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞

        const stream = await getLocalStream();
        if (!stream) return;

        createPeerConnection();
        stream.getTracks().forEach((track) => pc.addTrack(track, stream));

        await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp)); // –ü–µ—Ä–µ–¥–∞–µ–º msg.sdp
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º answer –∫:", msg.from, answer);
        ws.send(
          JSON.stringify({
            to: msg.from,
            type: "answer",
            sdp: answer, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º sdp –æ–±—ä–µ–∫—Ç
          })
        );
      }

      ws.onmessage = async (event) => {
        const msg = JSON.parse(event.data);
        console.log("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", msg);

        if (msg.yourId) {
          myId = msg.yourId;
          myIdEl.textContent = myId;
          console.log("–ú–æ–π ID:", myId);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä 'join'
          const urlParams = new URLSearchParams(window.location.search);
          const joinId = urlParams.get("join");
          if (joinId && joinId !== myId) {
            peerIdInput.value = joinId;
            // –ú–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            // startCall();
          }
          return;
        }

        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ pc –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer/answer/ice-candidate
        if (!pc && msg.type !== "offer") {
            console.warn("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ PeerConnection:", msg);
            return;
        }
        
        if (msg.type === "offer") {
          await handleOffer(msg);
          return;
        }

        if (msg.type === "answer") {
          console.log("–ü–æ–ª—É—á–µ–Ω answer:", msg);
          await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp)); // –ü–µ—Ä–µ–¥–∞–µ–º msg.sdp
          return;
        }

        if (msg.type === "ice-candidate") {
          console.log("–ü–æ–ª—É—á–µ–Ω ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç:", msg.candidate);
          try {
            await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞:", e);
          }
        }
      };

      function hangUp() {
        console.log("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞.");
        resetCallState();
      }

      function getMyId() {
        if (myId) {
          alert("–ú–æ–π ID: " + myId);
        } else {
          alert("ID –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
        }
      }

      function getLink() {
        if (!myId) {
          return alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞—à–µ–≥–æ ID!");
        }
        const url = new URL(window.location);
        url.searchParams.set("join", myId);
        const link = url.toString();

        navigator.clipboard
          .writeText(link)
          .then(() => alert("–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:\n" + link))
          .catch(() => alert("–°—Å—ã–ª–∫–∞:\n" + link));
      }

      ws.onopen = () => console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");
      ws.onclose = () => {
        console.log("‚ùå WebSocket –æ—Ç–∫–ª—é—á—ë–Ω. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–∞.");
        hangUp(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ WS
      };
      ws.onerror = (error) => {
        console.error("üö´ –û—à–∏–±–∫–∞ WebSocket:", error);
      };

      // –î–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ 'join' –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const joinId = urlParams.get("join");
        if (joinId) {
          peerIdInput.value = joinId;
        }
      };
    </script>
  </body>
</html>