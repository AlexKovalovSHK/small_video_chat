<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebRTC Video Call</title>
    <style>
      video {
        width: 48%;
        height: auto;
        border: 1px solid #ccc;
        background-color: #333; /* Для лучшей видимости пустых видеопотоков */
      }
      #localVideo {
        transform: scaleX(-1);
      } /* зеркальное отображение камеры */
    </style>
  </head>
  <body>
    <h2>WebRTC Video Call (ID: <span id="myId">?</span>)</h2>
    <p>
      Откройте эту страницу в двух вкладках. Введите ID другой вкладки и нажмите
      "Начать звонок".
    </p>
    <input id="peerIdInput" placeholder="ID собеседника" />
    <button onclick="startCall()">Начать звонок</button>
    <button onclick="hangUp()">Завершить</button>
    <button onclick="getMyId()">Get ID</button>
    <button onclick="getLink()">Get link</button>

    <div style="margin-top: 20px">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <script>
      const isLocalDev =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1";

      // НОВАЯ ЛОГИКА: Всегда используем wss, если страница загружена по https
      const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws`);

      let myId = null;
      let currentPeerId = null; // Изменено с peerId на currentPeerId для ясности
      let pc = null;
      let localStream = null; // Для хранения локального потока

      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const myIdEl = document.getElementById("myId");
      const peerIdInput = document.getElementById("peerIdInput"); // Получаем input

      // Функция для сброса состояния звонка
      function resetCallState() {
        if (pc) {
          pc.close();
          pc = null;
        }
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
        }
        localVideo.srcObject = null;
        remoteVideo.srcObject = null;
        currentPeerId = null;
        peerIdInput.value = "";
      }

      async function getLocalStream() {
        if (localStream) return localStream; // Возвращаем существующий поток, если уже есть
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          localVideo.srcObject = stream;
          localStream = stream; // Сохраняем поток
          return stream;
        } catch (e) {
          console.error("Камера/микрофон недоступны", e);
          alert("Разрешите доступ к камере и микрофону!");
          return null;
        }
      }

      function createPeerConnection() {
        // Закрываем предыдущее соединение, если оно есть
        if (pc) {
          pc.close();
        }

        pc = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        pc.onicecandidate = (event) => {
          if (event.candidate && currentPeerId) {
            // Убеждаемся, что currentPeerId установлен
            ws.send(
              JSON.stringify({
                to: currentPeerId,
                type: "ice-candidate",
                candidate: event.candidate,
              })
            );
          }
        };

        pc.ontrack = (event) => {
          console.log("Получен удаленный трек:", event.track, event.streams);
          if (remoteVideo.srcObject !== event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
          }
        };

        pc.onconnectionstatechange = () => {
          console.log("Состояние соединения:", pc.connectionState);
          if (pc.connectionState === "disconnected" || pc.connectionState === "failed" || pc.connectionState === "closed") {
            console.log("Соединение разорвано или не удалось. Развешиваем трубку.");
            hangUp();
          }
        };
      }

      async function startCall() {
        const targetPeerId = peerIdInput.value.trim(); // Используем новый input
        if (!targetPeerId) return alert("Введите ID собеседника!");
        if (!myId) return alert("Ожидайте получения вашего ID от сервера...");
        if (targetPeerId === myId) return alert("Нельзя звонить самому себе!");

        // Если звонок уже активен, сбрасываем его перед началом нового
        if (pc) {
          hangUp();
        }
        
        currentPeerId = targetPeerId; // Устанавливаем currentPeerId перед созданием PC

        const stream = await getLocalStream();
        if (!stream) return;

        createPeerConnection();
        stream.getTracks().forEach((track) => pc.addTrack(track, stream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        console.log("Отправляем offer к:", currentPeerId, offer);
        ws.send(
          JSON.stringify({
            to: currentPeerId,
            type: "offer",
            sdp: offer, // Отправляем sdp объект
          })
        );
      }

      async function handleOffer(msg) {
        console.log("Получен offer:", msg);
        // Если звонок уже активен, сбрасываем его перед началом нового
        if (pc) {
          hangUp();
        }

        currentPeerId = msg.from; // Устанавливаем currentPeerId от отправителя offer
        peerIdInput.value = currentPeerId; // Заполняем поле ввода ID собеседника

        const stream = await getLocalStream();
        if (!stream) return;

        createPeerConnection();
        stream.getTracks().forEach((track) => pc.addTrack(track, stream));

        await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp)); // Передаем msg.sdp
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        console.log("Отправляем answer к:", msg.from, answer);
        ws.send(
          JSON.stringify({
            to: msg.from,
            type: "answer",
            sdp: answer, // Отправляем sdp объект
          })
        );
      }

      ws.onmessage = async (event) => {
        const msg = JSON.parse(event.data);
        console.log("Получено сообщение:", msg);

        if (msg.yourId) {
          myId = msg.yourId;
          myIdEl.textContent = myId;
          console.log("Мой ID:", myId);

          // Проверяем URL на параметр 'join'
          const urlParams = new URLSearchParams(window.location.search);
          const joinId = urlParams.get("join");
          if (joinId && joinId !== myId) {
            peerIdInput.value = joinId;
            // Можно автоматически начать звонок, если нужно
            // startCall();
          }
          return;
        }

        // Убеждаемся, что pc инициализирован для обработки offer/answer/ice-candidate
        if (!pc && msg.type !== "offer") {
            console.warn("Получено сообщение до инициализации PeerConnection:", msg);
            return;
        }
        
        if (msg.type === "offer") {
          await handleOffer(msg);
          return;
        }

        if (msg.type === "answer") {
          console.log("Получен answer:", msg);
          await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp)); // Передаем msg.sdp
          return;
        }

        if (msg.type === "ice-candidate") {
          console.log("Получен ICE-кандидат:", msg.candidate);
          try {
            await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
          } catch (e) {
            console.error("Ошибка при добавлении ICE-кандидата:", e);
          }
        }
      };

      function hangUp() {
        console.log("Завершение звонка.");
        resetCallState();
      }

      function getMyId() {
        if (myId) {
          alert("Мой ID: " + myId);
        } else {
          alert("ID ещё не получен. Подождите немного или обновите страницу.");
        }
      }

      function getLink() {
        if (!myId) {
          return alert("Сначала дождитесь получения вашего ID!");
        }
        const url = new URL(window.location);
        url.searchParams.set("join", myId);
        const link = url.toString();

        navigator.clipboard
          .writeText(link)
          .then(() => alert("Ссылка для приглашения скопирована:\n" + link))
          .catch(() => alert("Ссылка:\n" + link));
      }

      ws.onopen = () => console.log("✅ WebSocket подключён");
      ws.onclose = () => {
        console.log("❌ WebSocket отключён. Сбрасываем состояние звонка.");
        hangUp(); // Сбрасываем состояние при отключении WS
      };
      ws.onerror = (error) => {
        console.error("🚫 Ошибка WebSocket:", error);
      };

      // Добавим обработку параметра 'join' при загрузке страницы
      window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const joinId = urlParams.get("join");
        if (joinId) {
          peerIdInput.value = joinId;
        }
      };
    </script>
  </body>
</html>