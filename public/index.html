<!-- public/index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebRTC Video Call</title>
    <style>
      video {
        width: 48%;
        height: auto;
        border: 1px solid #ccc;
      }
      #localVideo {
        transform: scaleX(-1);
      } /* –∑–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã */
    </style>
  </head>
  <body>
    <h2>WebRTC Video Call (ID: <span id="myId">?</span>)</h2>
    <p>
      –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –¥–≤—É—Ö –≤–∫–ª–∞–¥–∫–∞—Ö. –í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ
      "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫".
    </p>
    <input id="peerId" placeholder="ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞" />
    <button onclick="startCall()">–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
    <button onclick="hangUp()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    <button onclick="getMyId()">Get ID</button>
    <button onclick="getLink()">Get link</button>

    <div style="margin-top: 20px">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <script>
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      const isLocalDev =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1";

      const wsProtocol = isLocalDev ? "ws" : "wss";
      const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws`);

      let myId = null;
      let peerId = null;
      let pc = null;

      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const myIdEl = document.getElementById("myId");

      // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫
      async function getLocalStream() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          localVideo.srcObject = stream;
          return stream;
        } catch (e) {
          console.error("–ö–∞–º–µ—Ä–∞/–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã", e);
          alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É!");
        }
      }

      function createPeerConnection() {
        pc = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        pc.onicecandidate = (event) => {
          if (event.candidate) {
            ws.send(
              JSON.stringify({
                to: peerId,
                type: "ice-candidate",
                candidate: event.candidate,
              })
            );
          }
        };

        pc.ontrack = (event) => {
          remoteVideo.srcObject = event.streams[0];
        };
      }

      async function startCall() {
        peerId = document.getElementById("peerId").value.trim();
        if (!peerId) return alert("–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞!");
        if (!myId) return alert("–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞—à–µ–≥–æ ID –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞...");

        const stream = await getLocalStream();
        if (!stream) return;

        createPeerConnection();
        stream.getTracks().forEach((track) => pc.addTrack(track, stream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        ws.send(
          JSON.stringify({
            to: peerId,
            type: "offer",
            sdp: offer,
          })
        );
      }

      async function handleOffer(offer) {
        peerId = offer.from;
        const stream = await getLocalStream();
        if (!stream) return;

        createPeerConnection();
        stream.getTracks().forEach((track) => pc.addTrack(track, stream));

        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        ws.send(
          JSON.stringify({
            to: offer.from,
            type: "answer",
            sdp: answer,
          })
        );
      }

      // üî• –ö–õ–Æ–ß–ï–í–û–ô –ë–õ–û–ö: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      ws.onmessage = async (event) => {
        const msg = JSON.parse(event.data);

        // 1. –ü–æ–ª—É—á–∏–ª–∏ —Å–≤–æ–π ID –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        if (msg.yourId) {
          myId = msg.yourId;
          myIdEl.textContent = myId;
          console.log("–ú–æ–π ID:", myId);
          return;
        }

        // 2. –ü–æ–ª—É—á–∏–ª–∏ offer
        if (msg.type === "offer") {
          await handleOffer(msg);
          return;
        }

        // 3. –ü–æ–ª—É—á–∏–ª–∏ answer
        if (msg.type === "answer") {
          await pc.setRemoteDescription(new RTCSessionDescription(msg));
          return;
        }

        // 4. ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç
        if (msg.type === "ice-candidate") {
          try {
            await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ ICE:", e);
          }
        }
      };

      function hangUp() {
        if (pc) {
          pc.close();
          pc = null;
        }
        remoteVideo.srcObject = null;
      }

      function getMyId() {
        if (myId) {
          alert("–ú–æ–π ID: " + myId);
        } else {
          alert("ID –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
        }
      }

      function getLink() {
        if (!myId) {
          return alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞—à–µ–≥–æ ID!");
        }
        const url = new URL(window.location);
        url.searchParams.set("join", myId);
        const link = url.toString();

        // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä + –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        navigator.clipboard
          .writeText(link)
          .then(() => alert("–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:\n" + link))
          .catch(() => alert("–°—Å—ã–ª–∫–∞:\n" + link));
      }

      ws.onopen = () => console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");
    </script>
  </body>
</html>
